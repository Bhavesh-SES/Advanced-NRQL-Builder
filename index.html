<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Advanced NRQL Query Builder</title>
    <!-- Firebase Compat SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <!-- Select2 -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <style>
        /* ‚îÄ‚îÄ CORE TOOL STYLES ‚îÄ‚îÄ */
        header {
            background: #0077cc;
            color: #fff;
            padding: 20px;
            text-align: center;
            font-size: 24px;
        }

        :root {
            --bg: #f5f5f5;
            --text: #000;
            --card: #fff;
        }

        [data-theme="dark"] {
            --bg: #c9c9c9;
            --text: #fff;
            --card: #060000;
        }

        [data-theme="dark"] .select2-results__option {
            color: black !important;
        }

        [data-theme="dark"] .section h2 {
            color: white;
        }

        [data-theme="dark"] .select2-selection__choice {
            background: #fff !important;
            color: black !important;
        }

        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
        }

        .container {
            padding: 20px;
            max-width: 1200px;
            margin: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .section {
            background: var(--card);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .section h2 {
            margin-top: 0;
        }

        .row {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }

        select,
        input,
        button,
        textarea {
            padding: 5px;
            font-size: 14px;
        }

        textarea {
            width: 100%;
            height: 100px;
            font-family: monospace;
        }

        .filter-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .filter-row select,
        .filter-row input {
            min-width: 100px;
        }

        .filter-row button {
            background: red;
            color: #fff;
            border: none;
            cursor: pointer;
            padding: 0 8px;
        }

        #themeToggle {
            position: fixed;
            top: 10px;
            right: 10px;
        }

        /* ‚îÄ‚îÄ LOGIN SCREEN STYLES ‚îÄ‚îÄ */
        #authScreen {
            position: relative;
            height: 100vh;
            width: 100%;
            overflow: hidden;
        }

        #bgVideo {
            position: fixed;
            right: 0;
            bottom: 0;
            min-width: 100%;
            min-height: 100%;
            z-index: -1;
            filter: brightness(0.4);
        }

        .auth-container {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
        }

        .login-box {
            background: rgba(0, 0, 0, 0.7);
            padding: 30px 40px;
            border-radius: 10px;
            text-align: center;
            color: #fff;
            box-shadow: 0 0 30px #000;
            width: 320px;
            box-sizing: border-box;
        }

        .login-box h2 {
            margin-bottom: 20px;
        }

        /* Email & password inputs: identical size */
        .login-box input[type="email"],
        #authScreen .password-box input {
            width: 100%;
            height: 40px;
            padding: 8px 12px;
            box-sizing: border-box;
            border-radius: 5px;
            border: none;
            font-size: 16px;
            margin-bottom: 10px;
        }

        /* Password wrapper for eye icon */
        .password-box {
            position: relative;
            width: 100%;
            margin-bottom: 10px;
        }

        .password-box .icon-eye {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            width: 40px;
            height: 40px;
            line-height: 40px;
            text-align: center;
            font-size: 20px;
            cursor: pointer;
            color: #ccc;
            background: transparent;
            border: none;
            z-index: 2;
        }

        .password-box .icon-eye:hover {
            color: #fff;
        }

        .password-box input {
            padding-right: 48px;
            /* space for the icon */
        }

        /* Side-by-side Login / Sign Up buttons */
        #authScreen .buttons {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }

        #authScreen .buttons button {
            flex: 1;
            padding: 12px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #authScreen .buttons #loginBtn {
            background: #28a745;
            color: #fff;
        }

        #authScreen .buttons #signupBtn {
            background: #007bff;
            color: #fff;
        }
    </style>
</head>

<body data-theme="light">
    <!-- AUTH SCREEN -->
    <div id="authScreen" class="auth-container">
        <video autoplay muted loop id="bgVideo">
            <source src="city_rain.mp4" type="video/mp4">
            Your browser does not support HTML5 video.
        </video>
        <div class="login-box">
            <h2>Login</h2>
            <input type="email" id="emailInput" placeholder="Email" />
            <div class="password-box">
                <input type="password" id="passwordInput" placeholder="Password" />
                <button type="button" id="togglePassword" class="icon-eye">üëÅÔ∏è</button>
            </div>
            <div class="buttons">
                <button id="loginBtn">Login</button>
                <button id="signupBtn">Sign Up</button>
            </div>
            <div id="authMessage" style="color:red;"></div>
        </div>
    </div>
    <!-- TOOL SCREEN -->
    <div id="toolScreen" style="display:none">
        <header>Advanced NRQL Query Builder</header>
        <button id="themeToggle">Toggle Theme</button>
        <button id="logoutBtn">Log Out</button>
        <div class="container">
            <!-- Table & Column -->
            <div class="section">
                <h2>Table & Column Selection</h2>
                <div class="row">
                    <select id="tableSelect" style="width:200px;"></select>
                    <select id="columnSelect" multiple style="width:400px;"></select>
                </div>
            </div>
            <!-- Aggregation -->
            <div class="section">
                <h2>Aggregation</h2>
                <div class="row">
                    <select id="aggFunc">
                        <option value="">None</option>
                        <option>count</option>
                        <option>uniqueCount</option>
                        <option>average</option>
                        <option>min</option>
                        <option>max</option>
                        <option>sum</option>
                    </select>
                    <select id="aggColumn" style="width:400px"></select>
                </div>
            </div>
            <!-- Timeseries -->
            <div class="section" id="timeseriesSection" style="display:none">
                <h2>Time Series</h2>
                <select id="timeseriesInterval">
                    <option>1 minute</option>
                    <option>5 minutes</option>
                    <option>10 minutes</option>
                    <option>30 minutes</option>
                    <option>1 hour</option>
                </select>
            </div>
            <!-- Filters -->
            <div class="section">
                <h2>Filters (Where)</h2>
                <div id="filterContainer"></div>
                <button onclick="addFilter('AND')">+ AND</button>
                <button onclick="addFilter('OR')">+ OR</button>
            </div>
            <!-- Facet -->
            <div class="section">
                <h2>FACET</h2>
                <select id="facetSelect" multiple style="width:400px"></select>
            </div>
            <!-- Time Range -->
            <div class="section">
                <h2>Time Range</h2>
                <div class="row">
                    <label><input type="radio" name="timeType" value="relative" checked />Relative</label>
                    SINCE <input id="sinceVal" type="number" style="width:60px" />
                    <select id="sinceUnit">
                        <option>minutes</option>
                        <option>hours</option>
                        <option>days</option>
                        <option>weeks</option>
                    </select> ago
                    UNTIL <input id="untilVal" type="number" style="width:60px" />
                    <select id="untilUnit">
                        <option>minutes</option>
                        <option>hours</option>
                        <option>days</option>
                        <option>weeks</option>
                    </select> ago
                </div>
                <div class="row">
                    <label><input type="radio" name="timeType" value="absolute" />Absolute</label>
                    Start: <input id="absStartDate" type="date" /> <input id="absStartTime" type="time" step="1" />
                    End: <input id="absEndDate" type="date" /> <input id="absEndTime" type="time" step="1" />
                </div>
            </div>
            <!-- Limit -->
            <div class="section">
                <h2>Limit</h2>
                <input id="limitInput" type="text" placeholder="e.g. 100 or MAX" style="width:120px" />
            </div>
            <!-- Controls -->
            <div class="section">
                <h2>Query Controls</h2>
                <div class="row">
                    <button id="buildBtn">Build Query</button>
                    <label><input id="autoRefresh" type="checkbox" checked />Auto Refresh</label>
                </div>
            </div>
            <!-- Output -->
            <div class="section">
                <h2>NRQL Output</h2>
                <textarea id="queryOutput" readonly></textarea>
                <button class="copy-btn" onclick="copyQuery()">Copy</button>
            </div>
            <!-- Save/Load/Delete -->
            <div class="section">
                <h2>Save/Load Queries</h2>
                <div class="row">
                    <input id="queryName" type="text" placeholder="Enter Query name to Save !!" />
                    <button onclick="saveQuery()">Save</button>
                    <select id="savedQueries" style="width:200px"></select>
                    <button id="deleteQueryBtn">Delete</button>
                </div>
                <!-- Add this inside the same .section, after your Delete button -->
                <div class="row" style="margin-top: 10px;">
                    <textarea id="queryDesc" placeholder="Enter a description for this query‚Ä¶"
                        style="width:100%; height:60px; font-size:14px; padding:5px;"></textarea>
                </div>

            </div>
        </div>
    </div>
    <!-- Libraries -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
        document.getElementById('togglePassword').addEventListener('click', function () {
            const pwd = document.getElementById('passwordInput');
            const type = pwd.type === 'password' ? 'text' : 'password';
            pwd.type = type;
            this.textContent = type === 'password' ? 'üëÅÔ∏è' : 'üôà';
        });
    </script>
    <script>
        // Firebase init
        const ADMIN_UIDS = [
            '53J9oxFwO8hYp5QEIrm66mXL8ry2',  // existing admin
            'aBcDeFgHiJkLmNoPqRsTuVwXyZa'   // new admin UID
        ];
        const firebaseConfig = {
            apiKey: "AIzaSyAo1weIrZh82evreRglzTEKbzReRurVqeA",
            authDomain: "nrql-query-tool.firebaseapp.com",
            projectId: "nrql-query-tool",
            storageBucket: "nrql-query-tool.firebasestorage.app",
            messagingSenderId: "580238875628",
            appId: "1:580238875628:web:09ae949e29ba9646d4bec9",
            measurementId: "G-H5VTX0YMEL"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth(), db = firebase.firestore();
        const email = document.getElementById('loginEmail')?.value?.trim();
        const password = document.getElementById('loginPassword')?.value;
        // YOUR FULL SCHEMA HERE
        const SCHEMA = {
            AjaxRequest: ["*","Timestamp", "Agent Version", "App ID", "App Mode Type", "App Mode Variant", "App Name", "Asn", "Boot.Launch.Version.Bootstrap", "Boot.Launch.Version.Target", "Chapter", "City", "Client Ip", "Client Ip", "Content Country", "Core.Activity State", "Core.Adapter Version", "Core.Bootstrap Version", "Core.Chapter Name", "Core.Chapter Version", "Core.Content Country", "Core.Device Brand", "Core.Device Cpu Count", "Core.Device ID", "Core.Device Manufacturer", "Core.Device Model", "Core.Device Origin", "Core.Device OS Name", "Core.Device OS Version", "Core.Device Ram Gb", "Core.Device Store", "Core.Device Tier", "Core.Device Type", "Core.Device User Agent", "Core.Firmware Version", "Core.Fv Data File Revision", "Core.Nr Device Uuid", "Core.Partner ID", "Core.Platform", "Core.Session ID", "Core.User State", "Core.User Status", "Core.User Type", "Core.Zip Code", "Country Code", "Dazn ID", "Device ID", "Device Type", "Entity GUID", "Geo Country", "Hostname", "Http Method", "Http Response Code", "Is Auth Chapter", "Manufacturer", "Native App", "Page URL", "Platform", "Platform Type", "Region Code", "Request Body Size", "Request URL", "Response Body Size", "Session", "Session ID", "Session Trace ID", "Startup Response Data", "Time To Load Event Start", "Trace.ID", "User Status", "Viewer ID"],
            Javascript: ["*","Timestamp", "Action Text", "Agent Version", "App ID", "App Name", "Asn", "Asn Latitude", "Asn Longitude", "Asn Organization", "Billing Country", "Boot.Launch.Target", "Boot.Launch.Version.Bootstrap", "Boot.Launch.Version.Target", "Browser Interaction ID", "Browser Stack Hash", "Chapter", "Chapter Version", "City", "Client Ip", "Code", "Component Stack", "Content Country", "Country Code", "Dazn ID", "Description", "Device ID", "Device Type", "Domain", "Duration Ms", "Endpoint", "Entity GUID", "Environment Group", "Eraro Code", "Erro Name", "Error Category", "Error Class", "Error ID", "Error Message", "Error Status", "Error Tag", "First Error In Session", "First Occurrence Timestamp", "Geo Country", "In App", "Is Alib Canary User @Dazn/Match Day Panel Web", "Is Alib Canary User @Dazn/Sportsdata Web", "Is Auth Chapter", "Is Auto Refresh", "Jwt.Expired Iso", "Jwt.Expires", "Jwt.Issued", "Jwt.Issued Iso", "Manufacturer", "Name", "Native App", "News Locale", "Page Country", "Page Language", "Page URL", "Parent Event ID", "Payload", "Platform", "Random Ab Point", "Region Code", "Release Ids", "Request URI", "Response", "Retries", "Safe Mode", "Service", "Session ID", "Session Trace ID", "Source", "Source Caller", "Stack Hash", "Stack Trace", "Status", "Status Code", "Transaction Name", "Unhandled Promise Rejection", "User Agent Name", "User Agent OS", "User Agent Version", "User Status", "User Type", "Viewer ID", "Zendesk Locale"],
            PageAction: ["*","Timestamp", " Anonymous", " Asset ID", " Audio Codec", " Bandwidth Redundancy Ratio", " Cdn Name", " Cirr Recent", " Cirr Session", " Device ID", " Distance To Origin", " Fixture ID", " Hypercare", " Is Auto Play", " Is Top Bitrate", " Is Within Live Window", " Media Type", "Mhid", " Playback Sources", " Player Name", " Presentation Delay", " Quality Level Recent", " Quality Level Session", " Rotation Count", " Session ID", " Source Count", " Source Identifier", " Source Origin", " Source URL", " Stability Score Recent", " Stability Score Session", " Video Codec", " Viewer ID", "Action Name", "Active State", "Agent Version", "App ID", "App Mode Type", "App Mode Variant", "App Name", "Article ID", "Article Title", "Asn", "Asn Latitude", "Asn Longitude", "Asn Organization", "Billing Country", "Billing Period", "Boot.Launch.Target", "Boot.Launch.Version.Bootstrap", "Boot.Launch.Version.Target", "Browser", "Browser Height", "Browser Version", "Browser Width", "Cache Hit", "Cache Key", "Category", "Category ID", "Category Name", "Chapter", "Chapter Version", "City", "Click Source", "Client Ip", "Client Ip", "Connection Type", "Content Country", "Core.Adapter Version", "Core.Bootstrap Version", "Core.Chapter Name", "Core.Chapter Version", "Core.Content Country", "Core.Device Brand", "Core.Device Cpu Count", "Core.Device ID", "Core.Device Manufacturer", "Core.Device Model", "Core.Device Origin", "Core.Device OS Name", "Core.Device OS Version", "Core.Device Ram Gb", "Core.Device Store", "Core.Device Tier", "Core.Device Type", "Core.Device User Agent", "Core.Firmware Version", "Core.Fv Data File Revision", "Core.Nr Device Uuid", "Core.Partner ID", "Core.Platform", "Core.Session ID", "Core.User State", "Core.User Status", "Core.User Type", "Core.Zip Code", "Country Code", "Current URL", "Dazn ID", "Delay Init", "Device ID", "Device Model", "Device OS", "Device OS Version", "Device Platform", "Device Type", "Duration", "Duration Ms", "End Time", "End Time Seconds", "Entitlement Set ID", "Entity GUID", "Environment Group", "Error Message", "Firmware Version", "First Chunk Load", "Focused Ui", "Geo Country", "Group ID", "Has Development Path", "In App", "Inactive Mode Supported", "Init ID", "Is3pp Exit", "Is Alib Canary User @Dazn/Match Day Panel Web", "Is Alib Canary User @Dazn/Sportsdata Web", "Is Auth Chapter", "Is Cwc", "Is Overlay Shown", "Is Sign In Chapter", "Is Um Shown", "Jwt.Expired Iso", "Jwt.Expires", "Jwt.Issued", "Jwt.Issued Iso", "Language", "Languages", "Link ID", "Link Name", "Link Type", "Manufacturer", "Message", "Metric Name", "Muted", "Name", "Native App", "News Locale", "Original Server Error", "Package Name", "Package Version", "Page", "Page Country", "Page Language", "Page Locale", "Page URL", "Parsed Error", "Platform", "Platform Name", "Platform Type", "Product Group", "Pubby Action", "Pubby Client Configured", "Pubby Client Exists", "Random Ab Point", "Referrer URL", "Region Code", "Render Duration", "Request Payload", "Resource Strings Key", "Router Action", "Service Name", "Service Timeout", "Service URL", "Session", "Session ID", "Session Trace ID", "Severity", "Solution Version", "Source", "Source ID", "Span Name", "Specific Device", "Start Time", "Start Time Seconds", "Startup Response Data", "Step", "Success", "Time Since Load", "Token", "Token Expired", "Token Ttl", "Total Timespent", "URL Path", "User Agent Name", "User Agent OS", "User Agent Version", "User Status", "Value", "View Name", "Viewer ID", "Volume", "Was Subscribed"],
            Pageview: ["*","Timestamp", "Agent Version", "App ID", "App Mode Type", "App Mode Variant", "App Name", "Asn", "Asn Latitude", "Asn Longitude", "Asn Organization", "Backend Duration", "Boot.Launch.Target", "Boot.Launch.Version.Bootstrap", "Boot.Launch.Version.Target", "Browser Transaction Name", "City", "Client Ip", "Client Ip", "Connection Setup Duration", "Core.Adapter Version", "Core.Bootstrap Version", "Core.Chapter Name", "Core.Chapter Version", "Core.Content Country", "Core.Device Brand", "Core.Device Cpu Count", "Core.Device ID", "Core.Device Manufacturer", "Core.Device Model", "Core.Device Origin", "Core.Device OS Name", "Core.Device OS Version", "Core.Device Ram Gb", "Core.Device Store", "Core.Device Tier", "Core.Device Type", "Core.Device User Agent", "Core.Firmware Version", "Core.Fv Data File Revision", "Core.Nr Device Uuid", "Core.Partner ID", "Core.Platform", "Core.Session ID", "Core.User State", "Core.User Status", "Core.User Type", "Core.Zip Code", "Country Code", "Device ID", "Device Type", "Dns Lookup Duration", "Dom Processing Duration", "Domain", "Duration", "Entity GUID", "Environment Group", "First Contentful Paint", "First Paint", "Geo Country", "Has Replay", "Manufacturer", "Name", "Native App", "Network Duration", "Page Rendering Duration", "Page Trace ID", "Page URL", "Platform", "Platform Type", "Queue Duration", "Random Ab Point", "Region Code", "Secure Handshake Duration", "Session", "Session ID", "Session Trace ID", "Startup Response Data", "User Agent Name", "User Agent OS", "User Agent Version", "Viewer ID", "Web App Duration"]
        };
        // Populate table dropdown and wire up select2
        function initSchema() {
            const $t = $('#tableSelect').empty();
            Object.keys(SCHEMA).forEach(tbl => $t.append(new Option(tbl, tbl)));
            $t.select2({ placeholder: 'Search tables‚Ä¶', width: '200px' })
                .on('change', populateCols)
                .val('').trigger('change');
        }
        function populateCols() {
            const cols = SCHEMA[$('#tableSelect').val()] || [];
            $('#columnSelect').empty().append(new Option('*', '*'));
            cols.forEach(c => $('#columnSelect').append(new Option(c, c)));
            $('#columnSelect').trigger('change');

            ['#aggColumn', '#facetSelect'].forEach(sel => {
                const $s = $(sel).empty();
                cols.forEach(c => $s.append(new Option(c, c)));
                $s.trigger('change');
            });
        }


        // Dedupe helpers
        function addFilter(type = 'AND') {
            const row = $('<div class="filter-row"></div>');
            const op = $('<select><option>AND</option><option>OR</option></select>').val(type);
            const col = $('<select class="filter-column"></select>');
            (SCHEMA[$('#tableSelect').val()] || []).forEach(c => col.append(new Option(c, c)));
            const cond = $('<select><option>=</option><option>!=</option><option>LIKE</option>'
                + '<option>IN</option><option>NOT IN</option><option>BETWEEN</option>'
                + '<option>EXISTS</option><option>IS NULL</option><option>IS NOT NULL</option>'
                + '</select>');
            const val = $('<input type="text" placeholder="Enter value(s)‚Ä¶">');
            const del = $('<button>‚ùå</button>').click(() => row.remove());
            row.append(op, col, cond, val, del).appendTo('#filterContainer');
            col.select2({ width: '200px', placeholder: 'Column‚Ä¶', allowClear: true });
        }
        let autoId;
        function startAuto() { autoId = setInterval(buildQuery, 1000); }
        function stopAuto() { clearInterval(autoId); }
        function buildQuery() {
            if (!$('#tableSelect').val()) { return; }
            let q = 'SELECT ';
            const agg = $('#aggFunc').val(), aCol = $('#aggColumn').val();
            const cols = $('#columnSelect').val() || ['*'];
            q += agg ? `${agg}(${aCol})` : cols.join(', ');
            q += ` FROM ${$('#tableSelect').val()}`;
            const parts = [];
            $('#filterContainer .filter-row').each((i, row) => {
                const $r = $(row), op = $r.find('select').eq(0).val(),
                    col = $r.find('select').eq(1).val(),
                    cond = $r.find('select').eq(2).val(),
                    raw = $r.find('input').val() || '', v = cond.match(/IN|NOT IN/) ? `(${raw.split(',').map(x => " '" + x.trim() + "'").join(',')})`
                        : cond === 'BETWEEN' ? raw
                            : /NULL|EXISTS/.test(cond) ? ''
                                : `'${raw}'`;
                let clause = `${col} ${cond}` + (v ? ` ${v}` : '');
                parts.push(i ? `${op} ${clause}` : clause);
            });
            if (parts.length) q += ` WHERE ${parts.join(' ')}`;
            const f = $('#facetSelect').val(); if (f && f.length) q += ` FACET ${f.join(', ')}`;
            if (agg) {
                const ts = $('#timeseriesInterval').val();
                if (ts) q += ` TIMESERIES ${ts}`;
            }
            if ($('input[name="timeType"]:checked').val() === 'absolute') {
                const s = $('#absStartDate').val() + ' ' + $('#absStartTime').val(),
                    e = $('#absEndDate').val() + ' ' + $('#absEndTime').val();
                if (s) q += ` SINCE '${s}'`; if (e) q += ` UNTIL '${e}'`;
            } else {
                const sv = $('#sinceVal').val(), su = $('#sinceUnit').val(),
                    uv = $('#untilVal').val(), uu = $('#untilUnit').val();
                if (sv) q += ` SINCE ${sv} ${su} ago`; if (uv) q += ` UNTIL ${uv} ${uu} ago`;
            }
            const lim = $('#limitInput').val(); if (lim) q += ` LIMIT ${lim}`;
            $('#queryOutput').val(q);
        }
        function copyQuery() { navigator.clipboard.writeText($('#queryOutput').val()); }
        function saveQuery() {
            const name = $('#queryName').val().trim();
            if (!name) return alert('Please enter a name for your query.');
            const state = {
                table: $('#tableSelect').val() || '',               // never undefined
                columns: $('#columnSelect').val() || [],             // always an array
                aggFunc: $('#aggFunc').val() || '',
                aggColumn: $('#aggColumn').val() || '',
                filters: $('#filterContainer .filter-row').map((i, row) => {
                    const $row = $(row);
                    return {
                        op: $row.find('select').eq(0).val(),      // AND / OR
                        col: $row.find('select').eq(1).val(),      // column name
                        cond: $row.find('select').eq(2).val(),      // =, !=, LIKE, etc.
                        val: $row.find('input').val() || ''       // **always** grab the input‚Äôs value
                    };
                }).get(),
                facets: $('#facetSelect').val() || [],
                timeType: $('input[name="timeType"]:checked').val() || 'relative',
                since: {
                    num: $('#sinceVal').val() || '',
                    unit: $('#sinceUnit').val() || 'minutes'
                },
                until: {
                    num: $('#untilVal').val() || '',
                    unit: $('#untilUnit').val() || 'minutes'
                },
                abs: {
                    startDate: $('#absStartDate').val() || '',
                    startTime: $('#absStartTime').val() || '',
                    endDate: $('#absEndDate').val() || '',
                    endTime: $('#absEndTime').val() || ''
                },
                timeseries: $('#timeseriesInterval').val() || '',
                limit: $('#limitInput').val() || '',
                description: $('#queryDesc').val().trim()
            };
            db.collection('queries').doc(name).set(state)
                .then(loadSaved)
                .catch(e => alert('Save failed: ' + e.message));
            console.log('Saving state:', state);
        }
        function loadQuery(name) {
            stopAuto();              // pause auto-build while we rehydrate
            if (!name) return;

            db.collection('queries').doc(name).get().then(doc => {
                if (!doc.exists) return alert('Saved query not found.');
                const s = doc.data();

                // 1) pick the table (this fires populateCols)
                $('#tableSelect').val(s.table).trigger('change');

                // 2) once columns/Agg/Facet are repopulated (give it ~200ms)
                setTimeout(() => {
                    // restore multi-selects
                    $('#columnSelect').val(s.columns).trigger('change');
                    $('#aggFunc').val(s.aggFunc).trigger('change');
                    $('#aggColumn').val(s.aggColumn).trigger('change');
                    $('#facetSelect').val(s.facets).trigger('change');

                    // rebuild your filter rows
                    $('#filterContainer').empty();
                    s.filters.forEach(f => {
                        addFilter(f.op);
                        const $row = $('#filterContainer .filter-row').last();
                        $row.find('select').eq(1).val(f.col).trigger('change');
                        $row.find('select').eq(2).val(f.cond);
                        $row.find('input').val(f.val);
                    });

                    // time & limit
                    $('input[name="timeType"][value="' + s.timeType + '"]').prop('checked', true);
                    $('#sinceVal').val(s.since.num);
                    $('#sinceUnit').val(s.since.unit);
                    $('#untilVal').val(s.until.num);
                    $('#untilUnit').val(s.until.unit);
                    $('#absStartDate').val(s.abs.startDate);
                    $('#absStartTime').val(s.abs.startTime);
                    $('#absEndDate').val(s.abs.endDate);
                    $('#absEndTime').val(s.abs.endTime);
                    $('#timeseriesInterval').val(s.timeseries);
                    $('#limitInput').val(s.limit);
                    $('#queryDesc').val(s.description || '');

                    // 3) resume auto-refresh if they have it checked
                    if ($('#autoRefresh').prop('checked')) startAuto();
                }, 200);
            })
                .catch(err => alert('Load failed: ' + err.message));
        }


        function loadSaved() {
            db.collection('queries')
                .get()
                .then(snapshot => {
                    const sel = $('#savedQueries')
                        .empty()
                        .append('<option value="">-- Load --</option>');

                    snapshot.forEach(doc => sel.append(new Option(doc.id, doc.id)));

                    // Re-init Select2 after data is loaded
                    sel.select2({
                        placeholder: 'Search or select a saved query',
                        width: '50%' // ensures it stretches to fit
                    });
                });
        }



        // Auth & init
        auth.onAuthStateChanged(async user => {            // Show/hide login vs. tool screens
            $('#authScreen').toggle(!user);
            $('#toolScreen').toggle(!!user);
            if (!user) return;            // Fetch token with custom claims and check for an "admin" flag
            const { claims } = await user.getIdTokenResult();
            const isAdmin = !!claims.admin;            // Only admins see the Delete button
            $('#deleteQueryBtn').toggle(isAdmin);            // Initialize your tool UI exactly as before
            initSchema();
            $('#columnSelect,#facetSelect,#aggColumn')
                .select2({ width: '200px', placeholder: 'Select‚Ä¶' });
            $('#aggFunc').on('change', e => $('#timeseriesSection').toggle(!!e.target.value));
            $('#buildBtn').click(buildQuery);
            $('#autoRefresh').change(e => e.target.checked ? startAuto() : stopAuto());
            $('#savedQueries').change(e => loadQuery(e.target.value));
            $('#deleteQueryBtn').click(() => {
                const n = $('#savedQueries').val();
                if (!n) return alert('Select one');
                db.collection('queries').doc(n).delete().then(loadSaved);
            });
            // Finally load your saved queries
            loadSaved();
        });
        // In your auth.onAuthStateChanged (or initTool) after setting up the handlers:
        $('#autoRefresh').off('change')
            .on('change', e => e.target.checked ? startAuto() : stopAuto());

        // then, immediately if it‚Äôs already checked, fire it:
        if ($('#autoRefresh').prop('checked')) {
            startAuto();
        }
        $('#signupBtn').click(() => {
            auth.createUserWithEmailAndPassword(
                $('#emailInput').val().trim(),
                $('#passwordInput').val()
            ).catch(e => $('#authMessage').text(e.message));
        });
        $('#loginBtn').click(() => {
            auth.signInWithEmailAndPassword(
                $('#emailInput').val().trim(),
                $('#passwordInput').val()
            ).catch(e => $('#authMessage').text(e.message));
        });
        $('#themeToggle').click(() => document.body.dataset.theme = document.body.dataset.theme === 'light' ? 'dark' : 'light');
        $('#logoutBtn').click(() => {
            firebase.auth().signOut()
                .then(() => {                    // optional: clear UI, show auth screen
                    $('#toolScreen').hide();
                    $('#authScreen').show();
                })
                .catch(err => alert('Sign-out error: ' + err.message));
        });
    </script>
</body>

</html>
